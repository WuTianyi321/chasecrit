# 实验结果：SOC 算法接入与初步冒烟实验（2026-02-07）

## 1. 目标

本轮工作目标是建立一条最小闭环：

1. 在不启用 SOC 时保持与原有代码行为一致；
2. 在启用 SOC 后具备“慢驱动-阈值释放-级联传播”的基本机制信号；
3. 在追逃任务中进行小规模对照，获得初步趋势。

## 2. 实现概述

### 2.1 接入方式（默认兼容）

- `EvaderConfig` 新增 SOC 参数，默认 `soc_enabled=false`。
- `evader_step` 新增可选 SOC 分支；关闭时保持原有 `legacy/share` 逻辑。
- 新增状态容器 `EvaderSocState`（个体应力、对齐占比、上一步 toppling 记录）。
- `Simulation.summary()` 新增 SOC 观测量：
  - `soc_topple_steps`
  - `soc_topple_events_total`
  - `soc_topple_size_mean`
  - `soc_topple_size_var`
  - `soc_branch_ratio`

### 2.2 SOC 机制（当前版本）

对每个存活逃跑者 \(i\)：

1. 基础控制方向：  
   \[
   d_i = \lambda_i d_i^{align} + (1-\lambda_i)d_i^{nonalign}
   \]
2. 应力更新（慢驱动）：  
   \[
   s_i \leftarrow (1-\mu)s_i + \eta \cdot surprise_i + \kappa \cdot threat_i
   \]
3. 阈值触发（快释放）：若 \(s_i>\theta\) 则 toppling，执行：
   - \(s_i \leftarrow \max(0, s_i-r)\)
   - \(\lambda_i \leftarrow \lambda_i - \Delta\lambda\)
4. 邻居耦合（当前 dense 分支一轮传播）：toppling 节点向邻域增加应力。
5. 慢恢复：\(\lambda_i\) 向基础 `w_align` 缓慢回归。

### 2.3 `w_align` 的定义及其与 SOC 的关系

`w_align` 在本文中不是“是否使用 SOC”的开关，而是对齐倾向的基准参数；在不同模式下含义如下：

1. **SOC 关闭（baseline）**  
   `w_align` 为固定控制参数（或固定混合权重），整个 episode 内不随个体状态变化。
2. **SOC 开启（本文实现）**  
   每个体实际使用的是时变权重 \(\lambda_i(t)\)。`w_align` 用作 \(\lambda_i\) 的基准设定点（set-point）：
   - toppling 时 \(\lambda_i\) 被快速下调；
   - 非 toppling 时 \(\lambda_i\) 以慢时间尺度回归到 `w_align`。

因此，实验中扫描 `w_align` 的含义是：改变 SOC 系统的基准工作点，再观察该工作点附近的自适应动态（而不是让 \(\lambda_i\) 恒等于 `w_align`）。

## 3. 测试与一致性验证

新增测试：`tests/test_soc_mode.py`

1. `test_soc_disabled_keeps_evader_step_identical`  
   - 在 `soc_enabled=false` 下，即使传入 SOC 状态，输出速度与基线逐元素一致。
2. `test_soc_enabled_triggers_topple_and_updates_state`  
   - 构造低阈值场景，验证 toppling 触发、状态更新与边界约束生效。
3. `test_soc_parameter_changes_do_not_affect_run_when_disabled`  
   - 在 SOC 关闭时，修改 SOC 参数不改变任务统计结果。

全量校验：

- `uv run pytest -q` -> `9 passed, 3 skipped`
- `uv run pyright` -> `0 errors`

## 4. 初步实验设计（smoke）

### 4.1 任务设置

- 场景：默认追逃场景（`configs/base.toml`）
- 固定：`speed_ratio=1.1`，`steps=400`
- 扫描：`w_align ∈ {0.4, 0.6, 0.8}`（在 SOC-on 下表示 \(\lambda_i\) 的基准设定点）
- 重复：`seeds=0..19`（每点 20 次）

### 4.2 对照组

1. Baseline（SOC off）
   - sweep: `runs/sweep_20260207_103331_grid`
   - report: `doc/results_20260207_soc_smoke_baseline`
2. SOC-MVP（较强驱动）
   - config: `configs/soc_mvp.toml`
   - sweep: `runs/sweep_20260207_103347_grid`
   - report: `doc/results_20260207_soc_smoke_mvp`
3. SOC-Soft（较软驱动）
   - config: `configs/soc_mvp_soft.toml`
   - sweep: `runs/sweep_20260207_103434_grid`
   - report: `doc/results_20260207_soc_smoke_soft`

## 5. 结果摘要

### 5.1 性能（按 `safe_mean`）

| mode | w_align=0.4 | w_align=0.6 | w_align=0.8 |
|---|---:|---:|---:|
| baseline | 0.2699 | 0.2457 | 0.2848 |
| soc_mvp | 0.2395 | 0.2016 | 0.1383 |
| soc_soft | 0.2465 | 0.1410 | 0.0992 |

### 5.2 SOC 机制信号（`soc_mvp` 全体 60 runs）

- `soc_topple_steps` 平均约 `385.6 / 400`
- `soc_topple_events_total` 平均约 `2241.9`
- `soc_topple_size_mean` 平均约 `5.80`
- `soc_branch_ratio` 平均约 `1.11`

单次运行（`runs/soc_smoke/run_20260207_103237_703983_seed0`）显示：

- `soc_topple_steps=574 / 600`
- 正规模事件分布中，小规模事件占多数，存在延伸到较大规模（最大 23）的尾部。

## 6. 初步结论

1. 工程层面：SOC 开关已完成兼容接入，关闭时行为保持一致，测试通过。
2. 机制层面：启用后可稳定产生持续 toppling 与近 1 的分支比，满足“存在级联动力学信号”的最低要求。
3. 任务层面：在当前参数下，SOC 组尚未优于 baseline；表现更接近“过度活跃/偏超临界”而非“性能最优近临界”。

## 7. 下一步

为检验“SOC 是否能带来任务优势”，下一步优先做两类扫描：

1. 控制临界度的核心参数扫描：`soc_threshold`, `soc_neighbor_coupling`, `soc_align_drop`, `soc_surprise_gain`。
2. 任务压力分层验证：`speed_ratio` 分层（至少 `1.0, 1.2, 1.4`），分别比较“近临界带”与非临界带的 `safe_frac` 差异。
