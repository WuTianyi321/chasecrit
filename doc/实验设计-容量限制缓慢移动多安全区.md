# 实验设计：容量限制 + 缓慢移动的多安全区（局部可见、容量未知）

本文档把“现在要干什么”与**可直接实现/复现**的实验设计写清楚，作为近期的执行规范。SOC（自组织临界）先不作为主线，优先做“参数扫描 + 临界证据链 + 任务性能对齐”。

## 1. 现在要干什么（近期里程碑）

**目标**：在一个信息受限的追逃任务中，扫描逃跑者的从众/对齐强度（或噪声强度），并验证：

1) 是否存在清晰的近临界参数区（用相变/相关性证据链定位）；  
2) 追逃任务性能最优区域是否与近临界区域重合/相邻/无关；  
3) 结论在追捕者强度、边界、障碍等变化下是否稳健。

**核心场景**：多个**缓慢移动**的安全区，每个安全区有容量上限。逃跑者只能在靠近后发现安全区，并且**只能知道该安全区当前是否有效（可进入）**，不知道剩余容量；当容量耗尽时，安全区立刻失效并在逻辑上消失（不再可见/不可进入）。

## 2. 场景：世界、个体、可观测信息

### 2.1 世界（2D 连续）

- 空间：2D 连续平面。
- 时间：离散步 `t=0..T`，步长 `Δt`（建议先取 `Δt=1`，后续可做物理尺度化）。
- 边界模式（可切换）：
  - **Periodic**：二维环面（统计物理友好，便于相变定位）。
  - **Reflecting**：矩形边界反弹（更任务化）。
  - **Absorbing**（可选）：出界视为失败/被捕（更强约束，不建议一开始用）。
- 障碍模式（可切换）：
  - 无障碍（优先用于相变定位与基线任务）。
  - 多边形/圆形静态障碍（用于“任务化”展示与稳健性）。
  - 通道/瓶颈地图（后续增强，不建议一开始就上）。

### 2.2 逃跑者（Evaders）

每个逃跑者 `i` 状态：位置 `x_i(t)∈R^2`，速度 `v_i(t)∈R^2`。

**动力学约束（建议统一）**：
- 速度上限 `|v_i| ≤ v_e`；
- 加速度/转向上限（可选）：`|v_i(t+1)-v_i(t)| ≤ a_e`，让运动更平滑；
- 碰撞/重叠：用短程排斥力或硬核距离 `d_min`（避免数值爆炸）。

**可观测（局部）**：
- 邻居集合 `N_i`: 距离 `r_nbr` 内的逃跑者相对位置与速度（或朝向）。
- 追捕者集合 `P_i`: 距离 `r_pred` 内的追捕者相对位置与速度（可用 `r_pred ≥ r_nbr`）。
- 安全区集合 `G_i`: 距离 `r_detect` 内的安全区位置，以及该安全区是否有效 `active∈{0,1}`（仅此，不含剩余容量）。
- 不允许显式通信：无广播、无共享地图、无全局最优信息。

### 2.3 追捕者（Pursuers）

每个追捕者 `j` 状态：位置 `y_j(t)`，速度 `u_j(t)`，速度上限 `|u_j| ≤ v_p`。

建议按难度递进实现并用于稳健性实验：
- **P0 最近邻追逐**：追最近的逃跑者。
- **P1 预测拦截**：对目标做一阶预测，朝预计拦截点移动。
- **P2 协作分配**：多个追捕者对多个目标做分配（减少重复追同一目标）。

捕获规则：
- **默认（瞬时捕获）**：若存在 `||x_i - y_j|| ≤ r_cap`，则 `i` 被捕并移除/标记失败。
- **可选（持续捕获）**：要求上述条件持续 `τ_cap` 步后才捕获，用作后续对照实验的可调设置。

## 3. 安全区（缓慢移动、容量限制、局部可见、容量未知）

### 3.1 安全区状态与规则

安全区 `k` 状态：
- 位置 `g_k(t)∈R^2`（缓慢移动）；
- 有效标记 `active_k(t)∈{0,1}`；
- 容量 `cap_k`（整数，初始化时设定）；
- 已接纳人数 `occ_k(t)`。

进入规则（当 `active_k=1`）：
- 若逃跑者 `i` 距离 `||x_i-g_k|| ≤ r_safe`，则视为“到达并尝试进入”。
- 若 `occ_k < cap_k`：允许进入，`i` 成功并从场景移除（或标记“已安全”）；`occ_k += 1`。
- 若 `occ_k == cap_k`：该安全区立刻**失效并逻辑消失**：`active_k ← 0`，之后不再被检测到也不可进入。

信息约束：
- 逃跑者只有在 `||x_i-g_k|| ≤ r_detect` 才能知道此处存在安全区以及 `active_k`（但**不知道** `cap_k` 或 `cap_k-occ_k`）。
- 安全区失效后：在逻辑上消失，即 `active_k=0` 的安全区不再被任何逃跑者/追捕者“看到”（等价于从列表中移除）。

### 3.2 安全区移动模型（“缓慢移动”落地方案）

本阶段采用：

**G0 恒速随机游走（默认）**
- 每个安全区保持速度 `s_k(t)`，满足 `|s_k| ≤ v_g`（`v_g` 明显小于 `v_e`）。
- 每 `H` 步对方向做小扰动：`s_k ← Rot(δ) s_k`，`δ ~ Uniform[-δ_max, δ_max]`。
- 边界处理：Periodic 或反弹。

（可选扩展）**G1 Ornstein–Uhlenbeck（更平滑）**
- `s_k(t+1)= (1-λ)s_k(t) + σ ε`，再截断到 `|s_k|≤v_g`；
- `g_k(t+1)=g_k(t)+s_k(t+1)Δt`。

> 关键是 `v_g/v_e` 足够小（例如 `0.05~0.20`），保证“安全区移动”不会把任务变成纯追踪问题，同时又能打破静态地图的简单性。

### 3.3 容量设置（实验变量）

容量未知但存在，是本场景逼出“分裂探索 vs 快速共识”的关键。建议设计成可控的 scarcity：

- 最大有效数量 `K_active_max ∈ {2,3,4,6}`（与刷新机制共同决定“需要持续探索”的程度）。
- 每个安全区容量 `cap_k`（整数），可取：
  - 均匀：`cap_k = cap`（基准）。
  - 不均匀：从离散分布采样（例如一大多小），用于稳健性/困难模式。
- “瞬时名义容量比” `ρ_cap ∈ {0.7, 1.0, 1.3}`：用于标定每次刷新后、系统在任意时刻可见的资源规模（与 `N_e` 的相对量级）。一种简单的标定方式是令：
  - `K_active_max · E[cap_k] ≈ ρ_cap · N_e`
- 注意：由于存在刷新，**整段 episode 内可出现的累计席位数**受 `p_spawn` 与 `T` 影响。为避免任务退化为“必然全员可进”或“几乎无人可进”，应联合调节 `E[cap_k]`、`p_spawn`、`T`，使得 `E[累计可进入人数]` 在 `N_e` 的同一量级（例如 `0.7~1.3 N_e`）。

### 3.4 安全区刷新（随机重生）机制与“最大有效数量”约束

为避免出现长时间无安全区的退化情况，同时引入“信息不确定 + 动态资源”的任务压力，安全区采用**随机刷新（重生）**机制，并施加最大有效数量限制：

- 设定最大有效安全区数量 `K_active_max`。
- 系统维护当前有效集合 `A(t)={k | active_k(t)=1}`，并始终满足 `|A(t)| ≤ K_active_max`。
- 刷新触发：
  - 当某安全区因容量耗尽失效并消失后，系统进入“可刷新”状态；
  - 在每个时间步，以概率 `p_spawn` 生成一个新的安全区（若 `|A(t)| < K_active_max`）；若 `|A(t)| == K_active_max`，则不生成。
- “不会一直都没有安全区”的约束（硬约束）：
  - 若在任意时间步出现 `|A(t)| = 0`，则该步**强制生成** 1 个新安全区（不受 `p_spawn` 限制）。

刷新位置（与边界模式一致）：
- **有边界（Reflecting/有限矩形）**：刷新点从边界均匀采样（沿矩形周长均匀），并满足与障碍/个体的最小距离约束（见下）。
- **无显式边界（Periodic）**：刷新点在整个域内均匀采样。

刷新时的合法性约束（建议默认启用）：
- 与任意障碍保持距离 `≥ d_obs_min`；
- 与任意追捕者距离 `≥ d_p_spawn_min`（避免“出生即被堵死”）；
- 与任意现存安全区距离 `≥ d_g_min`（避免安全区几乎重合）。

> 说明：`K_active_max` 与 `p_spawn` 共同决定“资源出现的稀疏程度”和“群体是否需要持续探索”。其中 `|A|=0` 的强制刷新确保场景不会长期退化为“纯生存追逃”。

## 4. 逃跑者策略（用于参数扫描的基线）

先用一个“最小但够用”的局部规则策略，把可调参数明确做成 `w_align`（从众/对齐强度），后续再加更复杂的启发式。

### 4.1 合成控制向量（示意）

对每个逃跑者 `i` 计算期望速度方向 `d_i`（单位向量）：

1) **对齐项**（从众）：`d_align = normalize( Σ_{j∈N_i} v_j )`
2) **凝聚/吸引项**（可选）：`d_coh = normalize( mean_{j∈N_i}(x_j) - x_i )`
3) **排斥项**：近距离防碰撞
4) **威胁规避项**：`d_avoid = normalize( Σ_{p∈P_i} (x_i - y_p)/||x_i-y_p||^2 )`
5) **安全区趋向项**（仅当检测到 active 安全区）：`d_goal = normalize( g_best - x_i )`，其中 `g_best` 为检测到的最近 active 安全区
6) **探索项**：当未检测到安全区时的游走（小噪声随机方向或保持惯性）

合成（一个建议的最小配方）：

- 若检测到 `active` 安全区：  
  `d = normalize( w_goal d_goal + w_avoid d_avoid + w_align d_align + w_sep d_sep )`
- 若未检测到：  
  `d = normalize( w_explore d_explore + w_avoid d_avoid + w_align d_align + w_sep d_sep )`

**扫描参数**：
- 主参：`w_align ∈ [0,1]`（或映射到上式权重比例）。
- 备选控制参：角噪声 `η`（在 `d` 上加角噪声），也可单独扫描或与 `w_align` 形成二维扫描（建议先一维）。

速度更新：
- `v_i(t+1) = v_e · d`（或带惯性 `v_i←(1-β)v_i+β v_e d`）。

### 4.2 基线对照组（避免“只有一种策略”）

至少准备 3 个对照组：

- **B0 纯自主**：`w_align=0`（只规避 + 目标/探索）。
- **B1 纯从众**：`w_align=1`（更易拥挤与锁死）。
- **B2 固定中值**：`w_align=0.5`（常识基线）。

（可选）再加一个“启发式拥挤回避”版本：当检测到安全区但周围密度过高时降低 `w_align` 或转向探索，用于说明“临界优势是否可被简单启发式替代”。

## 5. 追捕者与难度标定（可调强度 + 递进）

### 5.1 强度参数

- 速度比：`r_v = v_p / v_e`（主难度旋钮）
- 数量比：`r_n = N_p / N_e`
- 捕获半径：`r_cap`

建议的起步网格（后续再扩）：
- `r_v ∈ {1.0, 1.05, 1.10, 1.20, 1.35}`
- `N_p ∈ {1, 2, 4}`（或按 `N_e` 比例）

### 5.2 递进策略

同一套逃跑者参数扫描，在 P0→P2 下重复，检验结论是否保持。

## 6. 终止条件、成功定义与指标

### 6.1 终止条件

一次 episode 在下列任一条件满足时结束：
- 达到最大时长 `T`；
- 所有逃跑者都已进入安全区（成功）或被捕（失败）；
-（可选）安全区全部失效后，继续运行到 `T`（研究“无目标生存”），或直接终止并判为部分失败（两种都可做对照）。

### 6.2 任务指标（性能）

最少报告这组（建议每个都有均值 + 分位数 + 置信区间）：

- `S_survive`：存活数（未被捕，不管是否进安全区）
- `S_safe`：进入安全区人数（真正“成功”）
- `t_safe`：到达安全区时间分布（如中位数/90%分位）
- `t_cap`：被捕时间分布
- `waste_congestion`（拥挤浪费）：安全区失效前后，在其附近徘徊/折返的个体数与时间（可用半径内停留时间积分近似）
- `split_merge`：集群分裂-重组次数（可用连通分量数随时间的变化统计）

### 6.3 临界性指标（证据链）

以能写进论文的“最低配置”为目标：

- 序参量：极化度 `P(t)=|Σ v_i|/N`，取时间平均 `⟨P⟩`
- 易感性：`χ = N · Var(P)` 或 `Var(P)` 在控制参扫描下的峰值
- 相关长度：速度/朝向涨落相关函数 `C(r)` 拟合相关长度 `ξ`（至少在关键参数附近计算）
-（可选加分）级联/事件：以“急转传播”定义事件规模分布（非主线，可后置）

## 7. 实验矩阵（建议的分阶段设计）

### 阶段 I：无追捕定位临界区（必须）

目的：先在更“干净”的条件下定位 `w_align`（或 `η`）的近临界区，避免追捕/安全区机制把相变信号淹没。

- 禁用追捕者，禁用安全区进入（或忽略安全区，纯群体运动）。
- 扫描 `w_align`（或噪声）并计算 `⟨P⟩, χ, ξ`。
- 做不同规模 `N_e ∈ {64, 128, 256}`（或可承受的 2~3 个），报告有限尺寸效应。

### 阶段 II：上主任务（移动多安全区 + 容量未知）

固定一套主场景参数（例如 `K=4, ρ_cap=1.0, v_g/v_e=0.1, r_detect/r_safe=3~5`），扫描 `w_align` 并评估任务指标。

建议最小扫描：
- `w_align` 取 11 个点：`0.0, 0.1, ..., 1.0`
- 每点随机种子 `M≥50`（先小 M 验证，再加大）

### 阶段 III：稳健性（审稿人最看重）

在阶段 II 找到“性能峰附近”的参数区后，只在该区附近密扫，并做以下变化：

- 追捕强度：`r_v` 与 `N_p` 变化（P0→P2 都做）
- 边界：Periodic vs Reflecting
- 障碍：无障碍 vs 少量障碍（密度不高，避免不可解释的几何效应）
- 容量稀缺：`ρ_cap ∈ {0.7, 1.0, 1.3}`
- 安全区移动速度：`v_g/v_e ∈ {0.0, 0.05, 0.10, 0.20}`

## 8. 复现与记录（强制要求）

每次运行必须记录：

- 版本信息（git hash 或代码版本号）
- 全部参数（含随机种子）
- 关键时间序列：`P(t)`、存活数随时间、各安全区 `active/occ` 随时间
- 事件日志：捕获事件、进入安全区事件、安全区失效事件（含时间戳与位置）

输出建议：
- 每个 episode 一个 JSON/Parquet（按实现便利选择），外加一个汇总 CSV/Parquet
- 统一目录结构：`runs/<date>/<exp_name>/...`（后续实现时在代码里固化）

## 9. 建议默认参数（第一版）

第一版可用默认参数（跑通闭环后再做网格化扫描）：

- `N_e=128`, `N_p=2`, `T=2000`
- `v_e=1.0`, `v_p = r_v · v_e`，先从 `r_v=1.1` 起
- `K_active_max=4`, `ρ_cap=1.0`，`cap_k` 均匀
- `v_g=0.1 v_e`, `H=50`, `δ_max=10°`
- `r_safe=1.0`, `r_detect=4.0`, `r_nbr=6.0`, `r_pred=10.0`, `r_cap=1.0`
- 边界：先 Periodic；障碍：先无
- 刷新：`p_spawn=0.02`（示例），并启用 `|A|=0` 强制刷新
- 刷新约束：`d_obs_min=2.0`, `d_p_spawn_min=8.0`, `d_g_min=6.0`（示例）

任务化变体：边界改为 Reflecting，并加入少量障碍；同时保留 Periodic/no-obstacle 作为相变定位的“干净对照”。
