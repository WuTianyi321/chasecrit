# 工程性能：第二轮提速与行为一致性验证

## 1. 目标

在不改变算法语义的前提下，提高模拟运行速度，并给出可复现的行为一致性验证基线。

## 2. 本轮实现概述

- 加速对象：
  - `evader_step` 热路径（对齐/分离/避让/目标/探索组合）；
  - `Simulation.step` 中捕获判定与入安全区判定；
  - 周期边界映射与单位向量归一化的高频基础计算。
- 实现方式：
  - 新增可选 `Numba` JIT 核心（默认启用，可通过 `prefer_numba=False` 或环境变量 `CHASECRIT_DISABLE_NUMBA=1` 回退）。
  - 保留原有 `NumPy` 路径作为严格回退基线。
  - `Simulation` 支持显式选择后端，便于 A/B 验证。
  - 新增并使用原地计算与缓冲区复用，减少每步临时数组分配：
    - `geometry.apply_periodic_inplace()`；
    - `Simulation` 捕获/安全区判定缓冲区；
    - `SafeZones.active_total` 常数时间活跃区计数缓存。
  - `evader_step` 内部减少重复计算（例如复用 `v_dir` 作为探索航向，避免重复归一化）。
- 环境兼容处理：
  - 在 `chasecrit/__init__.py` 中清理异常全局 `sys.path` 污染路径，确保项目运行时优先使用 `.venv` 依赖，避免 `numba` 与 `numpy` 版本错配。

## 3. 行为一致性测试

新增/更新测试：

- `tests/test_evader_step_equivalence.py`
  - 原始 dense 参考实现对齐测试（已有）。
  - workspace 与非 workspace 路径一致性测试（已有）。
  - 新增：Numba 路径与 NumPy 路径逐步输出一致性测试。
- `tests/test_numba_parity.py`
  - 小规模任务回归：Numba 与 NumPy 在多 seed 下 `safe`、`captured` 完全一致，关键统计量近似一致。
- `tests/test_sim_regression.py`
  - 回归快照固定在 `prefer_numba=False` 路径，保证历史基准可重复。
- `tests/test_benchmark_smoke.py`
  - 小规模测速入口 smoke test，保证基准工具可运行。
  - 新增 `Numba` 提速不退化 sanity test（保守阈值，避免环境抖动误报）。

当前测试状态：`uv run pytest -q` 通过（8 项）；`uv run pyright` 通过（0 error）。

## 4. 小规模测速基线（可复现）

执行命令：

`uv run chasecrit bench-speed --config configs/base.toml --iterations 256 --steps 240 --repeats 3 --seed 0 --json-out doc/bench_20260206_numba_speed_v2.json`

测速结果（均值，当前版本）：

- `evader_step` 微基准：
  - NumPy：`0.4451 s`
  - Numba：`0.1090 s`
  - 加速比：`4.08x`
- 整体模拟（`run_summary`）：
  - NumPy：`0.4593 s`
  - Numba：`0.1643 s`
  - 加速比：`2.80x`

行为一致性（同一批 seed）：

- `safe/captured` 计数不一致次数：`0`
- `max_safe_frac_delta = 0.0`
- `max_chi_delta = 1.05e-13`

与本轮优化前基线（`runs/bench_before_opt.json`）对比：

- `evader_step`：
  - NumPy：`0.4459s -> 0.4145s`（约 `7.0%` 改善）
  - Numba：`0.1162s -> 0.0974s`（约 `16.1%` 改善）
- `run_summary`：
  - NumPy：`0.4780s -> 0.4318s`（约 `9.7%` 改善）
  - Numba：`0.1740s -> 0.1535s`（约 `11.8%` 改善）

原始基准输出：

- `doc/bench_20260206_numba_speed_v2.json`
- `runs/bench_before_opt.json`
- `runs/bench_after_opt2.json`

## 5. 结论与使用建议

1. 在当前 `N_e=128` 默认规模下，第二轮优化后端到端模拟仍保持稳定提速（NumPy 与 Numba 均提升）。
2. 回归测试、Numba/NumPy 一致性测试与基准一致性检查均未发现行为偏移。
3. 建议后续所有大扫参实验保持：
   - 先跑 `uv run pytest -q`
   - 再跑 `uv run pyright`
   - 再跑一次 `bench-speed`（记录到 `doc/bench_*.json`）
   - 最后启动长扫并用 `progress.txt/progress.jsonl` 跟踪 ETA。
