# 2026-02-06 Daily Log

## Code / tooling changes

- Speed optimization (behavior-preserving):
  - Added `EvaderDenseWorkspace` scratch buffers to avoid per-step dense O(N²) allocations.
  - Added `wrap_delta_inplace()` and used it in the dense branch.
  - Simulation now creates and reuses an evader dense workspace when `N_e<=512`.
  - Tests updated to ensure workspace path matches the no-workspace baseline.
- Added additional criticality/structure proxies to `Simulation.summary()` and reporting:
  - `rho1_P`: lag-1 autocorrelation of `P(t)` (within-episode).
  - `tau_P_ar1`: AR(1)-based integrated correlation time proxy `τ=(1+ρ1)/(1-ρ1)`.
  - Reporting updated to include these fields; `report-noise` now also writes `group_summary.csv`.
- Progress files:
  - `runs/<sweep>/progress.txt` now includes `eta_at=<timestamp>` in addition to `eta_s` and run rate.

## Experiments run (expanded scale)

### Fixed pursuer-count scan (higher repeats)

- Command:
  - `uv run chasecrit sweep-grid --config configs/base.toml --speed-ratio 1.1 1.2 --w-align 0 0.05 0.1 0.15 0.2 0.25 0.3 0.35 0.4 0.45 0.5 0.55 0.6 0.65 0.7 0.75 0.8 0.85 0.9 0.95 1.0 --seeds 0..99 --steps 600 --no-save-events --no-save-timeseries --jobs 8`
- Raw sweep:
  - `runs/sweep_20260206_132212_grid/`
- Aggregated results:
  - `doc/results_20260206_fixedNp_sr11_sr12_100seeds/`
- Key snapshot (group means):
  - `speed_ratio=1.1`: best `safe_frac` at `w_align=0.70` (`safe_mean≈0.3725`), while `χ` peaks at `w_align=0.20`.
  - `speed_ratio=1.2`: best `safe_frac` at `w_align=0.40` (`safe_mean≈0.3416`), while `χ` peaks at `w_align=0.45`.

### Phase identification (noise control, higher repeats)

- Command:
  - `uv run chasecrit phase-sweep-noise --config configs/base.toml --noise 0 0.2 0.4 0.6 0.8 1.0 1.2 1.4 1.6 1.8 2.0 2.2 2.4 2.6 2.8 3.0 --seeds 0..99 --steps 1200 --jobs 8`
- Raw sweep:
  - `runs/sweep_20260206_133544_phase_noise/`
- Aggregated results:
  - `doc/results_20260206_phase_noise_100seeds_steps1200/`
- Key snapshot:
  - `χ` peak near `angle_noise≈1.8 rad`.
  - `χ_local` peak near `angle_noise≈1.4 rad`.

### Task validation (noise sweeps, higher repeats)

- B1 (task, `w_align=0.6`, `speed_ratio=1.1`):
  - Command:
    - `uv run chasecrit sweep-noise --config configs/base.toml --speed-ratio 1.1 --noise 0 0.2 0.4 0.6 0.8 1.0 1.2 1.4 1.6 1.8 2.0 2.2 2.4 2.6 2.8 3.0 --seeds 0..99 --steps 600 --w-align 0.6 --no-save-events --no-save-timeseries --jobs 8`
  - Raw: `runs/sweep_20260206_135213_noise/`
  - Aggregated: `doc/results_20260206_task_noise_w06_sr11_100seeds/`
  - Snapshot: best `safe_frac` at `angle_noise=0.0` (monotone decrease as noise increases).
- B2 (task, `w_align=1.0`, `speed_ratio=1.1`):
  - Raw: `runs/sweep_20260206_135744_noise/`
  - Aggregated: `doc/results_20260206_task_noise_w10_sr11_100seeds/`
  - Snapshot: best `safe_frac` at `angle_noise≈0.2` (low-noise optimum; high noise strongly degrades success).

## Docs updated (reader-facing)

- `doc/实验结果-固定追捕者数量扫描.md` now includes Experiment D (seeds=100) and τ proxy.
- `doc/实验结果-临界性验证-噪声控制参.md` now references the seeds=100 noise sweeps and expanded indicators.

## Status / next

- Need to commit + push all uncommitted code, docs, tests, and `doc/results_20260206_*` directories to GitHub.
- Consider whether the phase-identification setting (`w_goal=w_avoid=w_explore=0`) is the right “criticality baseline” for task comparison; it may not match task dynamics.

## Follow-up interpretation update (later on 2026-02-06)

- Re-checked `doc/results_20260206_task_noise_w10_sr11_100seeds/group_summary.csv` because user observed possible positive criticality-performance relation.
- Quantitative check confirms that in B2 (`w_align=1.0`) the in-task relation is positive:
  - `corr_Pearson(safe_mean, chi_mean)=0.824`
  - `corr_Spearman(safe_mean, chi_mean)=0.965`
- Added discussion to:
  - `doc/results_20260206_task_noise_w10_sr11_100seeds/report.md`
  - `doc/实验结果-临界性验证-噪声控制参.md`
- Interpretation refined:
  - Within-task noise sweep can show “higher `chi` with higher `safe`” (especially low-noise side).
  - This does not mean phase-identified critical noise (`~1.8`) is task-optimal.
- Updated `AGENTS.md` memory policy: `MEMORY.md` is no longer “incremental only”; structural re-organization is required when needed for clarity/retrieval.

## Engineering update (later on 2026-02-06)

- Added optional Numba acceleration path for `evader_step` dense neighbor interactions; NumPy fallback remains available.
- Added runtime backend toggle plumbing:
  - `evader_step(..., prefer_numba=...)`
  - `Simulation(..., prefer_numba=...)`
  - `run_summary(..., prefer_numba=...)` and `run_once(..., prefer_numba=...)`
- Added benchmark module and CLI:
  - `chasecrit bench-speed`
  - output artifact example: `doc/bench_20260206_numba_speed.json`
- Added/updated tests:
  - `tests/test_evader_step_equivalence.py` (Numba vs NumPy step-level equivalence)
  - `tests/test_numba_parity.py` (small-suite behavior parity)
  - `tests/test_benchmark_smoke.py` (benchmark smoke)
- Small-scale benchmark result:
  - `evader_step` speedup: ~`4.04x`
  - end-to-end simulation speedup: ~`2.62x`
  - behavior mismatches: `0`
- Added reader-facing performance report:
  - `doc/工程性能-加速与一致性验证.md`

## Active plan (task-internal criticality criterion)

Plan agreed with user:

1. Treat criticality by **in-task observed statistics** (`chi`, `chi_local`, `tau_P_ar1`, `xi_fluct`) instead of external pre-scan baselines.
2. Run a fixed-task `w_align` sweep (multi-seed, multi `speed_ratio`) and evaluate whether stronger in-task criticality aligns with higher `safe_frac`.
3. Quantify uncertainty with CI and stability checks:
   - if key comparisons are unstable (wide CI / rank flips), expand seeds and re-evaluate.
4. Re-summarize previous noise-induced experiments under the same in-task criterion.
5. Produce reader-facing report updates in `doc/`, then sync conclusions + reproducibility paths into `memory/MEMORY.md`.

## Engineering follow-up (speed optimization round 2)

- Goal:
  - Further reduce runtime before next large sweep, with behavior unchanged.
- Hotspot profiling:
  - Warmed profile still concentrated in `Simulation.step` and `evader_step`, especially high-frequency `wrap_delta`/`unit` and per-step temporary allocations.
- Code changes:
  - `src/chasecrit/geometry.py`
    - optimized `wrap_delta`/`unit`/`rotate`.
    - added `apply_periodic_inplace`.
  - `src/chasecrit/safe_zones.py`
    - added `active_total` cache for O(1) `active_count()`.
    - switched periodic move to in-place mapping.
  - `src/chasecrit/sim.py`
    - added reusable buffers for capture and safe-zone-entry checks.
    - switched periodic boundary updates to in-place.
    - reduced repeated active-zone counting in `_spawn_zones`.
  - `src/chasecrit/policies.py`
    - reduced repeated normalization and some temporary-array overhead in `evader_step` without changing RNG usage semantics.
  - `tests/test_benchmark_smoke.py`
    - added conservative Numba speedup sanity assertion.
- Validation commands:
  - `uv run pytest -q` -> `8 passed`
  - `uv run pyright` -> `0 errors`
- Benchmark artifacts:
  - Before optimization: `runs/bench_before_opt.json`
  - After optimization (comparison): `runs/bench_after_opt2.json`
  - Current doc baseline: `doc/bench_20260206_numba_speed_v2.json`
- Key benchmark comparison (`iterations=256`, `steps=240`, `repeats=3`, `seed=0`):
  - `evader_step` NumPy: `0.4459s -> 0.4145s` (~`7.0%` faster)
  - `evader_step` Numba: `0.1162s -> 0.0974s` (~`16.1%` faster)
  - Simulation NumPy: `0.4780s -> 0.4318s` (~`9.7%` faster)
  - Simulation Numba: `0.1740s -> 0.1535s` (~`11.8%` faster)

## Experiment continuation (near-criticality vs task performance, 2026-02-06 evening)

### Task-internal `w_align` sweep expansion

- Stability check on `doc/results_20260206_walign_task_internal_80seeds/group_summary.csv`:
  - top-vs-second `safe_mean` gaps were smaller than combined CI for all `speed_ratio` (`unstable point optimum`).
- Supplemental run to increase repeats:
  - command:
    - `uv run chasecrit sweep-grid --config configs/base.toml --speed-ratio 1.0 1.05 1.1 1.15 1.2 --w-align 0 0.05 ... 1.0 --seeds 80..199 --steps 600 --no-save-events --no-save-timeseries --jobs 8`
  - raw: `runs/sweep_20260206_154729_grid/` (`12600` runs)
- Merged with previous `80` seeds:
  - source A: `runs/sweep_20260206_151534_grid/results.csv`
  - source B: `runs/sweep_20260206_154729_grid/results.csv`
  - merged: `runs/sweep_20260206_merged_200seeds_grid/results.csv` (`21000` runs total)
  - merge metadata: `runs/sweep_20260206_merged_200seeds_grid/merge_info.json`
- Report:
  - `doc/results_20260206_walign_task_internal_200seeds/report.md`
  - `doc/results_20260206_walign_task_internal_200seeds/group_summary.csv`

### Pressure-contrast scenario study

- New sweep (`speed_ratio in {0.9, 1.3, 1.4}`, seeds `0..119`):
  - command:
    - `uv run chasecrit sweep-grid --config configs/base.toml --speed-ratio 0.9 1.3 1.4 --w-align 0 0.05 ... 1.0 --seeds 0..119 --steps 600 --no-save-events --no-save-timeseries --jobs 8`
  - raw: `runs/sweep_20260206_160622_grid/` (`7560` runs)
- Additional expansion for `speed_ratio=1.4` (to reduce ambiguity):
  - command:
    - `uv run chasecrit sweep-grid --config configs/base.toml --speed-ratio 1.4 --w-align 0 0.05 ... 1.0 --seeds 120..239 --steps 600 --no-save-events --no-save-timeseries --jobs 8`
  - raw: `runs/sweep_20260206_161736_grid/` (`2520` runs)
- Merged pressure dataset:
  - merged: `runs/sweep_20260206_merged_pressure_sr14_240_grid/results.csv` (`10080` runs)
  - merge metadata: `runs/sweep_20260206_merged_pressure_sr14_240_grid/merge_info.json`
- Report:
  - `doc/results_20260206_walign_pressure_091314_sr14_240seeds/report.md`
  - `doc/results_20260206_walign_pressure_091314_sr14_240seeds/group_summary.csv`

### Key findings (task-internal criterion)

- For `speed_ratio=1.0~1.3`, `corr(safe, chi)` is mostly positive (`~0.27` to `~0.62`).
- For `speed_ratio=1.4`, `corr(safe, chi)` is near zero (`~0.02`) and `corr(safe, xi)` turns negative.
- Across all tested `speed_ratio`, single-point optimum in `w_align` remains CI-unstable (flat-top behavior); report as an interval/band rather than a precise point.
- Top-`chi` quartile vs low-`chi` quartile:
  - `speed_ratio=1.0~1.2` shows small positive `safe` gain (`~+0.005` to `~+0.008`).
  - `speed_ratio=1.4` shows negative gain (`~-0.008`).

### Docs updated for readers

- Added latest task-internal results and reproducibility commands to:
  - `doc/实验结果-固定追捕者数量扫描.md` (new Section 8)
- Added cross-consistency section (noise route vs `w_align` route) to:
  - `doc/实验结果-临界性验证-噪声控制参.md` (new Section 5.1)

### Process/rules update

- Updated `AGENTS.md`:
  - added explicit rule under evaluation: task conclusions must prioritize **task-internal criticality ranking**; phase-baseline peaks cannot be directly used as task-optimal priors.

## Manuscript drafting (LaTeX)

- Completed repository push before drafting:
  - pushed `main` to `origin` at commit range `164857c..8f0fd26`.
- Added manuscript source:
  - `paper/main.tex`
- Local compile verification:
  - command: `latexmk -xelatex -interaction=nonstopmode -halt-on-error main.tex` (in `paper/`)
  - output: `paper/main.pdf` (5 pages)
- Cleanup:
  - removed temporary LaTeX artifacts via `latexmk -c`; kept `main.tex` and `main.pdf`.

## Manuscript revision (include all results)

- User requested that the paper should explicitly include strong-positive-correlation results from:
  - `doc/results_20260206_task_noise_w10_sr11_100seeds/report.md`
- Updated `paper/main.tex` to include:
  - full noise-route section (phase + task `w_align=0.6` + task `w_align=1.0`);
  - quantitative table with key correlations and peak-noise locations;
  - explicit statement of strong in-task coupling (`w_align=1.0`: Pearson `0.824`, Spearman `0.965`);
  - figures from `w10`, `w06`, and phase reports.
- Recompiled successfully:
  - `latexmk -g -xelatex -interaction=nonstopmode -halt-on-error main.tex` (in `paper/`)
  - output updated: `paper/main.pdf` (6 pages).

## Manuscript revision 2 (address user review)

- User feedback:
  - manuscript still missed many experiment results;
  - suspected Table 2 error (`arg max safe` / `arg max chi` looked all zeros).
- Verification from CSV:
  - `doc/results_20260206_task_noise_w10_sr11_100seeds/group_summary.csv`:
    - `argmax safe` at noise `0.2`, `safe_mean=0.3387`;
    - `argmax chi` at noise `0.0`, `chi_mean=4.2378`.
  - `doc/results_20260206_task_noise_w06_sr11_100seeds/group_summary.csv`:
    - both `argmax safe` and `argmax chi` at noise `0.0`.
- Paper fixes:
  - rewrote noise summary table to show both peak location and peak value explicitly;
  - marked phase-row `safe` as not-applicable (`--`) to avoid misread;
  - added appendix with broad experiment index (R1~R13), covering historical and latest result directories.
- Recompiled:
  - `latexmk -g -xelatex -interaction=nonstopmode -halt-on-error main.tex`
  - output updated: `paper/main.pdf` (7 pages).
